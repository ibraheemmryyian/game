<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salfeh Blind Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); }
    body { background-color: #0f172a; color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 hide-scrollbar">

  <main class="w-full max-w-md">
    <section id="setup" class="space-y-6">
      <h1 class="text-4xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">SALFEH BLIND</h1>

      <div class="bg-slate-800 p-6 rounded-3xl shadow-xl space-y-4 border border-slate-700">
        <div>
          <label for="playerCount" class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2 text-center">Number of Players</label>
          <input type="number" id="playerCount" value="3" min="3" max="50" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-4 text-center text-2xl font-bold focus:ring-2 focus:ring-purple-500 outline-none" inputmode="numeric" />
        </div>

        <div class="pt-2">
          <button id="startBtn" type="button" class="w-full card-gradient hover:opacity-90 transition-all py-5 rounded-2xl font-black text-xl shadow-lg uppercase tracking-wider">Start Game</button>
        </div>
      </div>

      <div class="bg-slate-800/50 p-4 rounded-2xl border border-slate-700/50">
        <p class="text-xs text-slate-400 mb-2 text-center font-semibold uppercase">Add Custom Pair (Optional)</p>
        <div class="flex gap-2">
          <label for="custom1" class="visually-hidden">Word A</label>
          <input type="text" id="custom1" maxlength="32" placeholder="Word A" class="w-1/2 bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none" />
          <label for="custom2" class="visually-hidden">Word B</label>
          <input type="text" id="custom2" maxlength="32" placeholder="Word B" class="w-1/2 bg-slate-900 border border-slate-700 rounded-lg p-2 text-sm outline-none" />
        </div>
      </div>
    </section>

    <section id="gameplay" class="hidden text-center space-y-6" aria-live="polite">
      <div class="bg-slate-800 p-8 rounded-[2.5rem] shadow-2xl border-2 border-slate-700 relative overflow-hidden">
        <div id="playerBadge" class="inline-block px-4 py-1 rounded-full bg-purple-500/20 text-purple-400 text-xs font-bold uppercase mb-4">Player 1</div>

        <div id="cardArea" class="py-8 px-4 bg-slate-900 rounded-3xl border-2 border-dashed border-slate-700">
          <div id="passScreen" class="space-y-4">
            <p id="passText" class="text-slate-400 font-medium">Pass the device to <span id="passPlayer">Player 1</span></p>
            <button id="revealBtn" type="button" class="w-full card-gradient hover:opacity-90 transition-all py-4 rounded-2xl font-black text-xl shadow-lg uppercase tracking-wider">Reveal Word</button>
          </div>

          <div id="secretCard" class="hidden cursor-pointer" tabindex="0">
            <p id="instruction" class="text-slate-500 font-medium">TAP TO REVEAL</p>
            <h3 id="secretWord" class="hidden text-5xl font-black tracking-tighter text-white uppercase italic" aria-live="assertive">---</h3>
          </div>
        </div>

        <button id="nextBtn" type="button" class="hidden w-full mt-8 bg-white text-slate-900 py-5 rounded-2xl font-black text-xl transition-transform active:scale-95 shadow-xl">I've Seen It</button>
      </div>

      <p class="text-slate-500 text-xs font-medium uppercase tracking-widest">Don't let anyone see your screen!</p>
    </section>
  </main>

  <script>
    // Category lists with focused, game-friendly words (related but not identical)
    const CATEGORIES = {
      food: [
        "Margherita", "Bolognese", "Tempura", "Bibimbap", "Shakshuka", "Ratatouille", "Gumbo", "Tapas",
        "Pierogi", "Ceviche", "Paella", "Risotto", "Tagine", "Souvlaki", "Pho", "Dumplings", "Enchilada", "Burrito", "Sashimi", "Gyoza"
      ],
      drinks: [
        "Espresso", "Cappuccino", "Matcha", "Chai", "Lemonade", "Kombucha", "Smoothie", "Mojito",
        "Latte", "Macchiato", "Earl Grey", "Cold Brew", "Milkshake", "Hot Chocolate", "Sake", "Port"
      ],
      jobs: [
        "Archivist", "Sommelier", "Cartographer", "Zoologist", "Paramedic", "Logistician", "Conservator",
        "Curator", "Surveyor", "Cartonist", "Producer", "Animator", "Linguist", "Diplomat", "Brewmaster",
        "Tailor", "Choreographer", "Sound Engineer", "Mediator", "Urban Planner"
      ],
      transport: [
        "Ferry", "Trolley", "Rickshaw", "Cable Car", "Seaplane", "Tram", "Monorail", "Scooter",
        "Cargo Ship", "Freight Train", "Hovercraft", "Gondola", "Subway", "Streetcar", "Motorbike"
      ],
      places: [
        "Boardwalk", "Conservatory", "Observatory", "Promenade", "Harbor", "Bayside", "Atrium",
        "Courtyard", "Meadow", "Plaza", "Boulevard", "Pavilion", "Market Square", "Pier"
      ],
      animals: [
        "Otter", "Badger", "Albatross", "Porcupine", "Meerkat", "Iguana", "Salamander", "Hedgehog",
        "Wren", "Macaque", "Gazelle", "Bison", "Puffin", "Kestrel", "Manatee"
      ],
      tech: [
        "Compiler", "Router", "Mainframe", "Firmware", "Drone", "Profiler", "Debugger", "Node",
        "Gateway", "Endpoint", "Kernel", "Container", "Framework", "SDK", "Daemon"
      ],
      entertainment: [
        "Improv", "Indie Film", "Podcast", "Arcade", "Opera", "Street Art", "Sketch Comedy",
        "Documentary", "Open Mic", "Art House", "Festival", "Escape Room", "Board Game", "Standup"
      ],
      objects: [
        "Lantern", "Compass", "Telescope", "Hammock", "Thermos", "Canister", "Trunk", "Sextant",
        "Binoculars", "Blueprint", "Lanai", "Workbench", "Kiln", "Turntable"
      ]
    };

    // Utility: Fisher-Yates shuffle (in-place)
    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // Choose a related-but-not-identical pair from categories:
    // - pick a category at random
    // - pick two distinct items that are not substrings of each other
    function pickRelatedPair() {
      const cats = Object.keys(CATEGORIES);
      // try a few times to avoid picking a bad pair
      for (let attempt = 0; attempt < 6; attempt++) {
        const cat = cats[Math.floor(Math.random() * cats.length)];
        const items = shuffleInPlace([...CATEGORIES[cat]]);
        // try to find two items that are distinct and not substrings of one another
        for (let i = 0; i < items.length; i++) {
          for (let j = i + 1; j < items.length; j++) {
            const a = items[i];
            const b = items[j];
            if (isAcceptablePair(a, b)) return [a, b];
          }
        }
      }
      // fallback: pick any two distinct words from any category
      const all = Object.values(CATEGORIES).flat();
      const s = shuffleInPlace([...all]);
      return [s[0], s[1]];
    }

    function isAcceptablePair(a, b) {
      if (!a || !b) return false;
      const la = a.toLowerCase();
      const lb = b.toLowerCase();
      if (la === lb) return false;
      if (la.includes(lb) || lb.includes(la)) return false;
      // avoid trivial person-object pairing by checking for common short words (simple heuristic)
      const shortWords = ["book","books","kitchen","office","clinic","class","school"];
      for (const w of shortWords) {
        if (la.includes(w) && !lb.includes(w) && isPersonLike(la)) return false;
        if (lb.includes(w) && !la.includes(w) && isPersonLike(lb)) return false;
      }
      return true;
    }

    // heuristic: words that look like job titles (endings or known tokens)
    function isPersonLike(word) {
      const tokens = ["ist","er","or","ian","ist","ographer","ian","maker","man","woman","engineer","designer","doctor","nurse","chef","baker","teacher","pilot"];
      for (const t of tokens) if (word.endsWith(t)) return true;
      return false;
    }

    // State
    let players = [];
    let currentIndex = 0;
    let numPlayers = 0;

    // Elements
    const startBtn = document.getElementById('startBtn');
    const setupSection = document.getElementById('setup');
    const gameplaySection = document.getElementById('gameplay');
    const playerBadge = document.getElementById('playerBadge');
    const passScreen = document.getElementById('passScreen');
    const secretCard = document.getElementById('secretCard');
    const revealBtn = document.getElementById('revealBtn');
    const instruction = document.getElementById('instruction');
    const secretWordEl = document.getElementById('secretWord');
    const nextBtn = document.getElementById('nextBtn');
    const passPlayer = document.getElementById('passPlayer');
    const playerCountInput = document.getElementById('playerCount');
    const custom1Input = document.getElementById('custom1');
    const custom2Input = document.getElementById('custom2');

    // Keyboard accessibility
    document.addEventListener('keydown', (e) => {
      if (gameplaySection.classList.contains('hidden')) return;
      if ((e.key === 'Enter' || e.key === ' ') && !passScreen.classList.contains('hidden')) {
        e.preventDefault(); revealBtn.click();
      } else if ((e.key === 'Enter' || e.key === ' ') && !secretCard.classList.contains('hidden') && secretWordEl.classList.contains('hidden')) {
        e.preventDefault(); revealWord();
      } else if ((e.key === 'Enter' || e.key === ' ') && !nextBtn.classList.contains('hidden')) {
        e.preventDefault(); nextBtn.click();
      }
    });

    startBtn.addEventListener('click', startGame);
    revealBtn.addEventListener('click', () => {
      passScreen.classList.add('hidden');
      secretCard.classList.remove('hidden');
      secretCard.focus();
    });

    secretCard.addEventListener('click', revealWord);
    secretCard.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') revealWord(); });

    nextBtn.addEventListener('click', () => {
      currentIndex++;
      setupTurn();
    });

    function startGame() {
      currentIndex = 0;
      numPlayers = Math.min(50, Math.max(3, parseInt(playerCountInput.value, 10) || 3));

      const c1 = custom1Input.value.trim();
      const c2 = custom2Input.value.trim();
      let pair;
      if (c1 && c2) {
        // If custom pair identical or too similar, warn and abort
        if (!isAcceptablePair(c1, c2)) {
          alert("Custom words too similar or not suitable â€” please use two distinct but related words (e.g. 'Margherita' and 'Bolognese').");
          return;
        }
        pair = [c1.slice(0,32), c2.slice(0,32)];
      } else {
        pair = pickRelatedPair();
      }

      // Randomize which becomes majority and which odd-one-out
      const [a, b] = shuffleInPlace([...pair]);
      const majorityWord = a;
      const oddWord = b;

      // Fill players with majorityWord, place exactly one oddWord
      players = Array(numPlayers).fill(majorityWord);
      const oddIndex = Math.floor(Math.random() * numPlayers);
      players[oddIndex] = oddWord;
      players = shuffleInPlace(players);

      setupSection.classList.add('hidden');
      gameplaySection.classList.remove('hidden');
      setupTurn();
    }

    function setupTurn() {
      if (currentIndex >= numPlayers) {
        showEndScreen();
        return;
      }

      playerBadge.textContent = `Player ${currentIndex + 1}`;
      passPlayer.textContent = `Player ${currentIndex + 1}`;

      passScreen.classList.remove('hidden');
      secretCard.classList.add('hidden');
      secretWordEl.classList.add('hidden');
      instruction.classList.remove('hidden');
      nextBtn.classList.add('hidden');

      secretWordEl.textContent = players[currentIndex];
      revealBtn.focus();
    }

    function revealWord() {
      secretWordEl.classList.remove('hidden');
      instruction.classList.add('hidden');
      nextBtn.classList.remove('hidden');
      if (navigator.vibrate) {
        try { navigator.vibrate(50); } catch (e) { }
      }
      nextBtn.focus();
    }

    function showEndScreen() {
      // create end screen safely using DOM methods to avoid injecting user text
      gameplaySection.innerHTML = '';
      const container = document.createElement('div');
      container.className = "bg-slate-800 p-8 rounded-[2.5rem] border border-slate-700 text-center";
      container.innerHTML = `
        <h2 class="text-4xl font-black mb-4">GAME ON!</h2>
        <p class="text-slate-400 leading-relaxed mb-6 font-medium">Everyone has their word. Start the conversation. Find the player who has the word that doesn't fit.</p>
      `;
      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = "space-y-3";
      const newRoundBtn = document.createElement('button');
      newRoundBtn.textContent = "New Round";
      newRoundBtn.className = "w-full bg-slate-700 py-4 rounded-2xl font-black text-lg uppercase tracking-widest shadow-lg";
      newRoundBtn.addEventListener('click', () => location.reload());
      const revealOddBtn = document.createElement('button');
      revealOddBtn.textContent = "Reveal Odd One Out";
      revealOddBtn.className = "w-full card-gradient py-4 rounded-2xl font-black text-lg uppercase tracking-widest shadow-lg";
      revealOddBtn.addEventListener('click', revealOddOneOut);
      buttonsDiv.appendChild(newRoundBtn);
      buttonsDiv.appendChild(revealOddBtn);
      container.appendChild(buttonsDiv);
      gameplaySection.appendChild(container);
    }

    function revealOddOneOut() {
      const tally = {};
      for (const w of players) tally[w] = (tally[w] || 0) + 1;
      let minWord = null, minCount = Infinity;
      for (const w in tally) {
        if (tally[w] < minCount) { minCount = tally[w]; minWord = w; }
      }

      // show overlay safely (textContent)
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 flex items-center justify-center bg-black/60 p-4';
      const panel = document.createElement('div');
      panel.className = 'bg-slate-900 p-6 rounded-3xl text-center border border-slate-700 max-w-sm';
      const h3 = document.createElement('h3');
      h3.className = 'text-3xl font-black mb-3';
      h3.textContent = 'Odd One Out';
      const p = document.createElement('p');
      p.className = 'text-slate-200 text-xl mb-6';
      p.textContent = String(minWord);
      const closeBtn = document.createElement('button');
      closeBtn.className = 'w-full bg-white text-slate-900 py-3 rounded-2xl font-bold';
      closeBtn.textContent = 'Close';
      closeBtn.addEventListener('click', () => overlay.remove());
      panel.appendChild(h3);
      panel.appendChild(p);
      panel.appendChild(closeBtn);
      overlay.appendChild(panel);
      document.body.appendChild(overlay);
      closeBtn.focus();
    }

    window.addEventListener('load', () => {
      startBtn.focus();
    });
  </script>
</body>
</html>